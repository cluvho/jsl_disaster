<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<head>
<title>재난대응시스템 - 게시글 상세</title>
<style>
/* ============================================= */
/* 기존 게시글 스타일                 */
/* ============================================= */
.post-container {
	max-width: 800px;
	margin: 0 auto;
	padding: 20px;
	background-color: #fff;
	border-radius: 8px;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.post-header {
	border-bottom: 2px solid #eee;
	padding-bottom: 15px;
	margin-bottom: 20px;
}

.post-title {
	font-size: 28px;
	font-weight: bold;
	color: #333;
	margin: 0;
}

.post-meta {
	font-size: 14px;
	color: #777;
	margin-top: 10px;
}

.post-body {
	font-size: 16px;
	line-height: 1.6;
	color: #555;
	white-space: pre-wrap; /* 공백 및 줄바꿈 유지 */
}

/* ============================================= */
/* ✅ 추가된 댓글 스타일               */
/* ============================================= */
.comment-section {
	margin-top: 40px;
	border-top: 1px solid #eee;
	padding-top: 20px;
}

.comment-header h5 {
	font-size: 18px;
	font-weight: 600;
	color: #333;
	margin-bottom: 20px;
}

.comment-form {
	display: flex;
	gap: 10px;
	margin-bottom: 30px;
}

.comment-form textarea {
	flex-grow: 1;
	border: 1px solid #ddd;
	border-radius: 6px;
	padding: 10px 12px;
	font-size: 15px;
	line-height: 1.5;
	min-height: 50px;
	resize: vertical;
}

.comment-form textarea:focus {
	outline: none;
	border-color: #555;
}

.comment-form button {
	border: none;
	background-color: #333;
	color: white;
	padding: 0 20px;
	font-size: 15px;
	font-weight: 500;
	border-radius: 6px;
	cursor: pointer;
	transition: background-color 0.2s;
}

.comment-form button:hover {
	background-color: #555;
}

.comment-list .comment {
	padding: 20px 0;
	border-top: 1px solid #f2f2f2;
}

.comment-list .comment:first-child {
	border-top: none;
}

.comment-meta {
	display: flex;
	align-items: center;
	gap: 10px;
	margin-bottom: 8px;
}

.comment-author {
	font-weight: 600;
	color: #333;
	font-size: 15px;
}

.comment-date {
	font-size: 13px;
	color: #888;
}

.comment-body {
	font-size: 15px;
	color: #555;
	line-height: 1.6;
}

.comment-actions {
	margin-top: 10px;
}

.comment-actions .reply-btn {
	background: none;
	border: none;
	color: #777;
	font-size: 13px;
	font-weight: 500;
	cursor: pointer;
	padding: 4px 0;
}

.comment-actions .reply-btn:hover {
	text-decoration: underline;
}

.reply-form {
	display: none; /* 기본적으로 숨김 */
	margin-top: 15px;
}

.reply-list {
	margin-top: 20px;
	margin-left: 25px;
	padding-left: 25px;
	border-left: 2px solid #f0f0f0;
}

/* 디테일 버튼 크기 조정 */
.write-btn {
	border: none;
	background-color: #333;
	color: white;
	font-weight: 500;
	border-radius: 6px;
	cursor: pointer;
	transition: background-color 0.2s;
	/* 패딩과 글자 크기 조절 */
	padding: 6px 12px; /* 상하 6px, 좌우 12px 패딩으로 크기 감소 */
	font-size: 13px; /* 글자 크기를 13px로 줄여 버튼 크기 감소 */
}
</style>
</head>

<body>
<div layout:fragment="content">
	<div class="post-container">
		<div th:if="${post != null}">
			<div class="post-header">
				<h4 class="post-title" th:text="${post.title}"></h4>
				<div class="post-meta">
					<span
						th:text="${post.disasterType.name()=='EARTHQUAKE'?'地震':
                                    post.disasterType.name()=='TSUNAMI'?'津波':
                                    post.disasterType.name()=='TYPHOON'?'台風':
                                    post.disasterType.name()=='FLOOD'?'豪雨・洪水':
                                    post.disasterType.name()=='VOLCANO'?'火山':
                                    post.disasterType.name()=='FIRE'?'火事':
                                    post.disasterType.name()=='LANDSLIDE'?'山崩れ':'その他'}">
					</span> <span>|</span> <span th:text="'作成者 : ' + ${post.nickname}" data-ko="작성자">작성자</span>
					<span>|</span> <span th:text="'照会数 : ' + ${post.viewCount}" data-ko="조회수">조회수</span>
					<span>|</span> <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
					<div class="flex items-center gap-4" style="float: right;">
						<a
							th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.memberId == post.memberId}"
							th:href="@{/community/delete/{postId}(postId=${post.postId})}"
							class="write-btn" data-ko="삭제">削除</a> <a
							th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.memberId == post.memberId}"
							th:href="@{/community/edit/{postId}(postId=${post.postId})}"
							class="write-btn" data-ko="수정">修整</a> <a th:href="@{/community/main}"
							class="write-btn" data-ko="목록">リスト</a> <a
							th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.memberId != post.memberId}"
							th:href="@{/report/post/{postId}(postId=${post.postId})}"
							class="write-btn" data-ko="신고">報告</a>
					</div>
				</div>
			</div>
			<p class="post-body" th:utext="${post.body}"></p>
		</div>

		<div th:unless="${post != null}" data-ko="해당 게시글을 찾을 수 없습니다.">
			<p>文を探すことができません。</p>
		</div>

		<!-- ✅ 지도 표시 영역 수정 -->
		<div class="post-content">
			<div id="post-location-container" class="post-location">
				<h4 style="margin-bottom: 10px;" data-ko="위치정보">位置情報</h4>
				<div id="map" style="width:100%; height:400px; border-radius: 8px;"></div>
			</div>
		</div>

		<div class="comment-section">
			<div class="comment-header">
				<h5>
					<span data-ko="댓글">コメント</span> 
					<span th:text="${comments != null ? #lists.size(comments) : 0}">0</span>
					<span data-ko="개">件</span>
				</h5>
			</div>

			<form th:action="@{/comment/add(postId=${post.postId})}"
				method="post" class="comment-form">
				<input type="hidden" name="parentId" value="">
				<textarea name="body"
					placeholder="コメントは本人の他の人格です。問題になるコメントはアイディーの削除および法律的な対応が可能です。"
					required data-ko="댓글은 자신의 또다른 인격입니다. 문제되는 댓글을 남길경우 계정삭제 및 법적대응이 가능합니다."></textarea>
				<button type="submit" data-ko="등록">登録</button>
			</form>

			<div class="comment-list">
				<!-- 원본 댓글 반복 -->
				<div th:each="cmt : ${comments}" th:if="${cmt.parentId == null}"
					class="comment">
					<div th:if="${cmt.status == 'DELETED'}">
						<p class="comment-body" style="color: #999;" data-ko="(삭제된 댓글입니다.)">（削除になったコメントです。）</p>
					</div>
					<div th:unless="${cmt.status == 'DELETED'}">
						<div class="comment-meta">
							<span class="comment-author" th:text="${cmt.nickname}"></span> <span
								class="comment-date"
								th:text="${#temporals.format(cmt.createdAt,'yyyy.MM.dd HH:mm')}"></span>
						</div>
						<p class="comment-body" th:text="${cmt.body}"></p>
						<div class="comment-actions">
							<button type="button" class="reply-btn" data-ko="답글">コメント</button>
							<a class="reply-btn"
							   th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.memberId != cmt.memberId}"
							   th:href="@{/report/comment/{commentId}(commentId=${cmt.commentId}, postId=${post.postId})}" data-ko="신고">報告</a>
							<form
								th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.memberId == cmt.memberId}"
								th:action="@{/comment/delete/{commentId}(commentId=${cmt.commentId})}"
								method="post" style="display: inline;">
								<input type="hidden" name="postId" th:value="${post.postId}">
								<button type="submit" class="reply-btn"
									onclick="return confirm('本当に削除しますか？');" data-ko="삭제" data-ko-confirm="정말로 삭제하시겠습니까?">削除</button>
							</form>
						</div>
					</div>

					<form th:action="@{/comment/add(postId=${post.postId})}"
						method="post" class="comment-form reply-form">
						<input type="hidden" name="parentId" th:value="${cmt.commentId}">
						<textarea name="body"
							placeholder="コメントは本人の他の人格です。問題になるコメントはアイディーの削除および法律的な対応が可能です。"
					required data-ko="댓글은 자신의 또다른 인격입니다. 문제되는 댓글을 남길경우 계정삭제 및 법적대응이 가능합니다."></textarea>
						<button type="submit" data-ko="등록">登録</button>
					</form>

					<div class="reply-list">
						<div th:each="reply : ${comments}"
							th:if="${reply.parentId == cmt.commentId}" class="comment reply">
							<div th:if="${reply.status == 'DELETED'}">
								<p class="comment-body" style="color: #999;" data-ko="(삭제된 댓글입니다.)">（削除になったコメントです。）</p>
							</div>
							<div th:unless="${reply.status == 'DELETED'}">
								<div class="comment-meta">
									<span class="comment-author" th:text="${reply.nickname}"></span>
									<span class="comment-date"
										th:text="${#temporals.format(reply.createdAt,'yyyy.MM.dd HH:mm')}"></span>
								</div>
								<p class="comment-body" th:text="${reply.body}"></p>
								<div class="comment-actions">
									<a class="reply-btn"
									   th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.memberId != reply.memberId}"
									   th:href="@{/report/comment/{commentId}(commentId=${reply.commentId}, postId=${post.postId})}" data-ko="신고">報告</a>
									<form
										th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.memberId == reply.memberId}"
										th:action="@{/comment/delete/{commentId}(commentId=${reply.commentId})}"
										method="post" style="display: inline;">
										<input type="hidden" name="postId" th:value="${post.postId}">
										<button type="submit" class="reply-btn"
											onclick="return confirm('本当に削除しますか？');" data-ko="삭제" data-ko-confirm="정말로 삭제하시겠습니까?">削除</button>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- ✅✅✅ 스크립트 영역 추가 ✅✅✅ -->
<th:block layout:fragment="script">
    <!-- Google Maps API -->
    <!-- 'YOUR_GOOGLE_MAPS_API_KEY' 부분에 발급받은 API 키를 입력해야 합니다. -->
    <script async defer
             src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdiJWNOl98gTR6XjCfDhubMwXQZVO3ejs&callback=initMap&libraries=marker&v=weekly">
    </script>

    <script th:inline="javascript">
        // 댓글 답글 폼 토글 스크립트
        document.addEventListener('DOMContentLoaded', function () {
            // '답글' 버튼에만 이벤트 리스너를 추가합니다. (신고/삭제 버튼 제외)
            const replyToggleButtons = document.querySelectorAll('.comment-actions .reply-btn:first-child');
            replyToggleButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const form = this.closest('.comment').querySelector('.reply-form');
                    if (form) {
                        if (form.style.display === 'flex') {
                            form.style.display = 'none';
                        } else {
                            form.style.display = 'flex';
                        }
                    }
                });
            });
        });

        // Google Map 초기화 함수
        function initMap() {
            // Controller로부터 전달받은 게시글의 좌표를 사용합니다.
            const postLat = /*[[${post.lat}]]*/ null;
            const postLon = /*[[${post.lon}]]*/ null;

            // 좌표 정보가 있는지 확인합니다.
            if (postLat != null && postLon != null) {
                const mapPosition = { lat: postLat, lng: postLon };

                const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 16,
                    center: mapPosition,
                    disableDefaultUI: true, // 기본 UI(줌 컨트롤 등) 비활성화
                    gestureHandling: 'cooperative' // 스크롤 시 의도치 않은 줌 방지
                });

                const marker = new google.maps.Marker({
                    position: mapPosition,
                    map: map,
                    // 상세 페이지에서는 마커를 드래그할 수 없도록 합니다.
                    draggable: false 
                });
            } else {
                // 좌표 정보가 없는 경우, 지도 영역을 숨기거나 메시지를 표시합니다.
                const mapContainer = document.getElementById('post-location-container');
                if(mapContainer) {
                    mapContainer.innerHTML = '<h4>위치 정보</h4><p>이 게시물에는 등록된 위치 정보가 없습니다.</p>';
                }
            }
        }
    </script>
</th:block>
</body>
</html>

