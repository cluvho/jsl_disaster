<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者ページ</title>
    <link rel="stylesheet" href="/css/mystyle.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="admin-page-wrapper">
    <aside class="admin-sidebar">
        <div class="logo">
            <a href="#">Admin Panel</a>
        </div>
        <nav>
            <ul>
                <li><a id="nav-dashboard" class="active">📊 ダッシュボード</a></li>
                <li><a id="nav-community">🛠️ コミュニティ管理</a></li>
                <li><a id="nav-deleted-content">🗑️ 削除されたコンテンツ管理</a></li>
                <li><a id="nav-log">📜 管理者活動ログ</a></li>
            </ul>
        </nav>
    </aside>

    <div class="admin-main-content">

        <!-- 1. ダッシュボードビュー -->
        <div id="dashboard-view">
            <header class="admin-header">
                <h1>ダッシュボード</h1>
                <div class="user-info"><a th:href="@{/logout}">ログアウト</a></div>
            </header>
            <main class="content-container">
                <section class="dashboard-cards">
                    <div class="card">
                        <h3>新規登録者</h3>
                        <div class="stat-number" th:text="${count}">12</div>
                    </div>
                    <div class="card">
                        <h3>投稿数</h3>
                        <div class="stat-number" th:text="${post}">34</div>
                    </div>
                    <div class="card">
                        <h3>コメント数</h3>
                        <div class="stat-number" th:text="${comment}">78</div>
                    </div>
                    <div class="card">
                        <h3>総会員数</h3>
                        <div class="stat-number" th:text="${total}">1,234</div>
                    </div>
                </section>
            </main>
        </div>

        <!-- 2. コミュニティ管理ビュー -->
        <div id="community-management-view" style="display: none;">
            <header class="admin-header">
                <h1>コミュニティ管理</h1>
                <div class="user-info"><a th:href="@{/logout}">ログアウト</a></div>
            </header>
            <main class="content-container">
                <!-- 投稿管理 -->
                <div class="management-section" id="post-table-fragment" th:fragment="post-table-fragment">
    					<div class="section-header"><h2>投稿管理</h2></div>
                    <table class="data-table">
                        <thead>
                            <tr><th>ID</th><th>タイトル</th><th>投稿者</th><th>投稿日</th><th>状態</th><th>管理</th></tr>
                        </thead>
                        <tbody>
                            <tr th:each="post : ${postList}">
                                <td data-label="ID" th:text="${post.postId}"></td>
                                <td data-label="タイトル" th:text="${post.title}"></td>
                                <td data-label="投稿者" th:text="${post.nickname}"></td>
                                <td data-label="投稿日" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd')}"></td>
                                <td data-label="状態" th:text="${post.status}"></td>
                                <td data-label="管理">
								    <form th:action="@{/admin/soft-delete-post}" method="post" onsubmit="return confirm('この投稿を非表示にしますか？');">
								        <input type="hidden" name="postId" th:value="${post.postId}" />
								        <button type="submit" class="btn btn-danger">非表示</button>
								    </form>
								</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" th:if="${totalPages > 0}">
				        <a th:if="${currentPage > 1}" href="javascript:void(0);" th:onclick="|loadPostPage(${currentPage - 1})|">&laquo;</a>
				    
				        <a th:each="pageNumber : ${#numbers.sequence(1, totalPages)}"
				           href="javascript:void(0);" 
				           th:onclick="|loadPostPage(${pageNumber})|"
				           th:text="${pageNumber}"
				           th:class="${pageNumber == currentPage} ? 'active'">
				        </a>
				        
				        <a th:if="${currentPage < totalPages}" href="javascript:void(0);" th:onclick="|loadPostPage(${currentPage + 1})|">&raquo;</a>
				    </div>
                    
                
                </div>

                <!-- 通報されたコメント管理 -->
                
                <div class="management-section" id="reported-comment-table-fragment" th:fragment="reported-comment-table-fragment">
                     <div class="section-header"><h2>通報されたコメント管理</h2></div>
                    <table class="data-table">
                         <thead>
                            <tr><th>ID</th><th>内容</th><th>投稿者</th><th>投稿日</th><th>原文</th><th>管理</th></tr>
                        </thead>
                        <tbody>
                            <tr th:each="comment : ${commentList}">
                                <td data-label="ID" th:text="${comment.commentId}"></td>
                                <td data--label="内容" th:text="${comment.body}"></td>
                                <td data-label="投稿者" th:text="${comment.nickname}"></td>
                                <td data-label="投稿日" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd')}"></td>
                                <td data-label="原文">
								    <a th:href="@{/post/{id}(id=${comment.postId})}" th:text="${comment.title}" target="_blank"></a>
								</td>
                                <td data-label="管理">
								    <form th:action="@{/admin/soft-delete-comment}" method="post" onsubmit="return confirm('このコメントを非表示にしますか？');">
								        <input type="hidden" name="commentId" th:value="${comment.commentId}" />
								        <button type="submit" class="btn btn-danger">非表示</button>
								    </form>
								</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="pagination" th:if="${commentTotalPages > 0}">
                        <a th:if="${commentCurrentPage > 1}" href="javascript:void(0);" th:onclick="|loadReportedCommentPage(${commentCurrentPage - 1})|">&laquo;</a>
                        <a th:each="pageNumber : ${#numbers.sequence(1, commentTotalPages)}"
                           href="javascript:void(0);"
                           th:onclick="|loadReportedCommentPage(${pageNumber})|"
                           th:text="${pageNumber}"
                           th:class="${pageNumber == commentCurrentPage} ? 'active'">
                        </a>
                        <a th:if="${commentCurrentPage < commentTotalPages}" href="javascript:void(0);" th:onclick="|loadReportedCommentPage(${commentCurrentPage + 1})|">&raquo;</a>
                    </div>
                </div>
                <!-- 会員管理 -->
                <div class="management-section" id="member-table-fragment" th:fragment="member-table-fragment">
                     <div class="section-header"><h2>会員管理</h2></div>
                    <table class="data-table">
                        <thead>
	                         <tr><th>ID</th><th>メール</th><th>氏名</th><th>住所</th><th>登録日</th><th>管理</th></tr>
	                     </thead>
	                     <tbody>
	                         <tr th:each="member : ${memberList}">
	                             <td data-label="ID" th:text="${member.memberId}"></td>
	                             <td data-label="メール" th:text="${member.email}"></td>
	                             <td data-label="氏名" th:text="${member.name}"></td>
	                             <td data-label="住所" th:text="${member.postalCode}"></td>
	                             <td data-label="登録日" th:text="${#dates.format(member.createdAt, 'yyyy-MM-dd')}"></td>
	                             <td data-label="管理">
					                <form method="post" th:action="@{/admin/deleteMember}" onsubmit="return confirm('本当にこの会員を削除しますか？');">
					                    <input type="hidden" name="memberId" th:value="${member.memberId}" />
					                    <button type="submit" class="btn btn-danger">削除</button>
					                </form>
					            </td>
	                         </tr>
	                     </tbody>
                    </table>
                    <div class="pagination" th:if="${memberTotalPages > 0}">
                        <a th:if="${memberCurrentPage > 1}" href="javascript:void(0);" th:onclick="|loadMemberPage(${memberCurrentPage - 1})|">&laquo;</a>
                    
                        <a th:each="pageNumber : ${#numbers.sequence(1, memberTotalPages)}"
                           href="javascript:void(0);" 
                           th:onclick="|loadMemberPage(${pageNumber})|"
                           th:text="${pageNumber}"
                           th:class="${pageNumber == memberCurrentPage} ? 'active'">
                        </a>
                        
                        <a th:if="${memberCurrentPage < memberTotalPages}" href="javascript:void(0);" th:onclick="|loadMemberPage(${memberCurrentPage + 1})|">&raquo;</a>
                    </div>
                    </div>
            </main>
        </div>
        
        <!-- 3. 削除されたコンテンツ管理ビュー -->
        <div id="deleted-content-view" style="display: none;">
            <header class="admin-header">
                <h1>削除されたコンテンツ管理</h1>
                <div class="user-info"><a th:href="@{/logout}">ログアウト</a></div>
            </header>
            <main class="content-container">
                <div class="management-section" id="soft-deleted-post-table-fragment" th:fragment="soft-deleted-post-table-fragment">
                    <div class="section-header"><h2>削除された投稿</h2></div>
                    <table class="data-table">
                        <thead>
                            <tr><th>ID</th><th>タイトル</th><th>投稿者</th><th>通報/削除理由</th><th>管理</th></tr>
                        </thead>
                        <tbody>
                            <tr th:each="post : ${deletedPostList}">
                                <td data-label="ID" th:text="${post.postId}"></td>
                                <td data-label="タイトル" th:text="${post.title}"></td>
                                <td data-label="投稿者" th:text="${post.nickname}"></td>
                                <td data-label="通報/削除理由" th:text="${post.reportReason ?: '理由なし'}"></td>
                                <td data-label="管理">
                                    <form th:action="@{/admin/hard-delete-post}" method="post" onsubmit="return confirm('この投稿を完全に削除します。復元できません。');">
                                        <input type="hidden" name="postId" th:value="${post.postId}" />
                                        <button type="submit" class="btn btn-danger">完全削除</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" th:if="${deletedPostTotalPages > 0}">
                        <a th:if="${deletedPostCurrentPage > 1}" href="javascript:void(0);" th:onclick="|loadSoftDeletedPostPage(${deletedPostCurrentPage - 1})|">&laquo;</a>
                        <a th:each="pageNumber : ${#numbers.sequence(1, deletedPostTotalPages)}"
                           href="javascript:void(0);"
                           th:onclick="|loadSoftDeletedPostPage(${pageNumber})|"
                           th:text="${pageNumber}"
                           th:class="${pageNumber == deletedPostCurrentPage} ? 'active'">
                        </a>
                        <a th:if="${deletedPostCurrentPage < deletedPostTotalPages}" href="javascript:void(0);" th:onclick="|loadSoftDeletedPostPage(${deletedPostCurrentPage + 1})|">&raquo;</a>
                    </div>
                </div>
                
                <div class="management-section" id="soft-deleted-comment-table-fragment" th:fragment="soft-deleted-comment-table-fragment">
                    <div class="section-header"><h2>削除されたコメント</h2></div>
                    <table class="data-table">
                        <thead>
                            <tr><th>ID</th><th>内容</th><th>投稿者</th><th>通報/削除理由</th><th>管理</th></tr>
                        </thead>
                        <tbody>
                            <tr th:each="comment : ${deletedCommentList}">
                                <td data-label="ID" th:text="${comment.commentId}"></td>
                                <td data-label="内容" th:text="${comment.body}"></td>
                                <td data-label="投稿者" th:text="${comment.nickname}"></td>
                                <td data-label="通報/削除理由" th:text="${comment.reportReason ?: '理由なし'}"></td>
                                <td data-label="管理">
                                    <form th:action="@{/admin/hard-delete-comment}" method="post" onsubmit="return confirm('このコメントを完全に削除します。復元できません。');">
                                        <input type="hidden" name="commentId" th:value="${comment.commentId}" />
                                        <button type="submit" class="btn btn-danger">完全削除</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination" th:if="${deletedCommentTotalPages > 1}">
                        <a th:if="${deletedCommentCurrentPage > 0}" href="javascript:void(0);" th:onclick="|loadSoftDeletedCommentPage(${deletedCommentCurrentPage - 1})|">&laquo;</a>
                        <a th:each="pageNumber : ${#numbers.sequence(1, deletedCommentTotalPages)}"
                           href="javascript:void(0);"
                           th:onclick="|loadSoftDeletedCommentPage(${pageNumber})|"
                           th:text="${pageNumber}"
                           th:class="${pageNumber == deletedCommentCurrentPage} ? 'active'">
                        </a>
                        <a th:if="${deletedCommentCurrentPage < deletedCommentTotalPages}" href="javascript:void(0);" th:onclick="|loadSoftDeletedCommentPage(${deletedCommentCurrentPage + 1})|">&raquo;</a>
                    </div>
                </div>
            </main>
        </div>

        <!-- 4. 管理者活動ログビュー -->
        <div id="admin-log-view" style="display: none;">
            <header class="admin-header">
                <h1>管理者活動ログ</h1>
                <div class="user-info"><a th:href="@{/logout}">ログアウト</a></div>
            </header>
            <main class="content-container">
                <div class="management-section">
                    <div class="section-header"><h2>活動ログ</h2></div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ログID</th>
                                <th>管理者</th>
                                <th>活動内容</th>
                                <th>対象情報</th>
                                <th>理由/備考</th>
                                <th>活動日時</th>
                            </tr>
                        </thead>
                       <tbody>
                            <tr th:if="${logList == null or logList.isEmpty()}">
                                <td colspan="6" style="text-align: center;">活動ログがありません。</td>
                            </tr>
                            <tr th:each="log : ${logList}">
                                <td data-label="ログID" th:text="${log.logId}"></td>
                                <td data-label="管理者" th:text="${log.adminNickname}"></td>
                                <td data-label="活動内容" th:text="${log.action}"></td>
                                <td data-label="対象情報">
                                    <th:block th:switch="true">
                                        <span th:case="${log.targetPostId != null}" th:text="'投稿 #' + ${log.targetPostId}"></span>
                                        <span th:case="${log.targetCommentId != null}" th:text="'コメント #' + ${log.targetCommentId}"></span>
                                        <span th:case="${log.targetUserId != null}" th:text="'ユーザー #' + ${log.targetUserId}"></span>
                                        <span th:case="${log.targetReportId != null}" th:text="'通報 #' + ${log.targetReportId}"></span>
                                        <span th:case="*">-</span> 
                                    </th:block>
                                </td>
                                <td data-label="理由/備考" th:text="${log.note}"></td>
                                <td data-label="活動日時" th:text="${#temporals.format(log.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="pagination" th:if="${logTotalPages > 0}">
                        <a th:if="${logCurrentPage > 1}" href="javascript:void(0);" th:onclick="|loadLogPage(${logCurrentPage - 1})|">&laquo;</a>
                        <a th:each="pageNumber : ${#numbers.sequence(1, logTotalPages)}"
                           href="javascript:void(0);" 
                           th:onclick="|loadLogPage(${pageNumber})|"
                           th:text="${pageNumber}"
                           th:class="${pageNumber == logCurrentPage} ? 'active'">
                        </a>
                        <a th:if="${logCurrentPage < logTotalPages}" href="javascript:void(0);" th:onclick="|loadLogPage(${logCurrentPage + 1})|">&raquo;</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<script>
// 자바스크립트 코드는 변경 없이 그대로 사용
document.addEventListener('DOMContentLoaded', function () {
    const navDashboard = document.getElementById('nav-dashboard');
    const navCommunity = document.getElementById('nav-community');
    const navDeletedContent = document.getElementById('nav-deleted-content');
    const navLog = document.getElementById('nav-log');

    const dashboardView = document.getElementById('dashboard-view');
    const communityView = document.getElementById('community-management-view');
    const deletedContentView = document.getElementById('deleted-content-view');
    const adminLogView = document.getElementById('admin-log-view');

    function switchView(activeNav, activeView) {
        document.querySelectorAll('.admin-sidebar nav a').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.admin-main-content > div').forEach(el => el.style.display = 'none');
        
        activeNav.classList.add('active');
        activeView.style.display = 'block';
    }

    navDashboard.addEventListener('click', (event) => {
        event.preventDefault();
        switchView(navDashboard, dashboardView);
    });

    navCommunity.addEventListener('click', (event) => {
        event.preventDefault();
        switchView(navCommunity, communityView);
    });

    navDeletedContent.addEventListener('click', (event) => {
        event.preventDefault();
        switchView(navDeletedContent, deletedContentView);
    });

    navLog.addEventListener('click', (event) => {
        event.preventDefault();
        switchView(navLog, adminLogView);
    });
});


//게시글 페이징
function loadPostPage(page) {
    // 1. fetch API를 사용해 1단계에서 만든 Controller 메소드 호출
    fetch(`/admin/api/posts?page=${page}`)
        .then(response => response.text()) // 응답을 텍스트(HTML)로 변환
        .then(html => {
            // 2. 받아온 HTML 조각으로 기존 #post-table-fragment 영역의 내용을 통째로 교체
            document.getElementById('post-table-fragment').innerHTML = html;
        })
        .catch(error => console.error('Error:', error));
}


//회원 페이징 
function loadMemberPage(page) {
    fetch(`/admin/api/members?page=${page}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('member-table-fragment').innerHTML = html;
        })
        .catch(error => console.error('Error:', error));
}


//신고된 댓글 페이징
function loadReportedCommentPage(page) {
    fetch(`/admin/api/reported-comments?page=${page}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('reported-comment-table-fragment').innerHTML = html;
        })
        .catch(error => console.error('Error fetching reported comments page:', error));
}

//소프트 삭제된 게시글 페이징
function loadSoftDeletedPostPage(page) {
    fetch(`/admin/api/soft-deleted-posts?page=${page}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('soft-deleted-post-table-fragment').innerHTML = html;
        })
        .catch(error => console.error('Error fetching soft deleted post page:', error));
}


//소프트 삭제된 댓글 페이징
function loadSoftDeletedCommentPage(page) {
    fetch(`/admin/api/soft-deleted-comments?page=${page}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('soft-deleted-comment-table-fragment').innerHTML = html;
        })
        .catch(error => console.error('Error fetching soft deleted comment page:', error));
}


// 관리자 로그 페이징 
function loadLogPage(page) {
    fetch(`/admin/api/logs?page=${page}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('log-table-fragment').innerHTML = html;
        })
        .catch(error => console.error('Error:', error));
}






</script>

</body>
</html>