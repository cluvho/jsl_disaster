<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light border-0 py-4">
                        <h2 class="text-center mb-0" style="font-weight: 700;" th:text="|${reportTarget} 신고|">신고</h2>
                    </div>
                    <div class="card-body p-4 p-md-5">
                        <form th:action="@{${formAction}}" th:object="${reportDto}" method="post">
                            
                            <!-- ✅✅✅ 이 부분이 핵심입니다! ✅✅✅ -->
                            <!-- 신고 대상 ID와, 리다이렉트에 필요한 postId를 숨겨서 전송합니다. -->
                            <input type="hidden" name="targetId" th:value="${targetId}" />
                            <input type="hidden" name="postId" th:if="${postId != null}" th:value="${postId}" />
                            
                            <!-- 신고대상 내용 -->
                            <div class="mb-4">
                                <label class="form-label"><strong th:text="|신고대상 ${reportTarget}|">신고대상</strong></label>
                                <textarea class="form-control form-control-lg" th:text="${targetContent}" readonly rows="3"></textarea>
                            </div>
                            
                            <!-- 신고 사유 -->
                            <div class="mb-4">
                                <label for="reason" class="form-label">
                                    <strong>사유</strong> <span style="color: red;">*</span>
                                </label>
                                <select id="reason" class="form-control form-control-lg" th:field="*{reason}" required>
                                    <option value="">선택하세요</option>
                                    <option value="FAKE">허위정보</option>
                                    <option value="ABUSE">욕설/비방</option>
                                    <option value="SPAM">스팸/도배</option>
                                    <option value="SEXUAL">음란물</option>
                                    <option value="OTHER">기타</option>
                                </select>
                            </div>

                            <!-- 상세 내용 -->
                            <div class="mb-4">
                                <label for="post-content" class="form-label">
                                    <strong>상세 내용</strong>
                                </label>
                                <textarea id="post-content" th:field="*{details}"></textarea>
                            </div>
                            
                            <p>※ 장난성 및 보복성 등의 허위신고는 계정 삭제처리가 될 수 있습니다.</p>
                            <p>※ 이로 인하여 사이트 내에 문제가 발생 시 법적대응이 가능합니다.</p>

                            <!-- 버튼 -->
                            <div class="d-grid gap-2 mt-5">
                                <button type="submit" class="btn btn-primary btn-lg" 
                                        onclick="return confirm('정말로 신고하시겠습니까?');">신고하기</button>
                                <button type="button" class="btn btn-secondary btn-lg" onclick="history.back();">취소하기</button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">

    <!-- 스타일 -->
    <style>
        .form-label {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .form-control-lg {
            font-size: 1rem;
            padding: 0.75rem 1rem;
        }
        .note-editor.note-frame {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: none;
        }
        .note-editor.note-frame:focus-within {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .card-body .d-grid .btn {
            padding: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
    </style>

    <!-- 라이브러리 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/lang/summernote-ko-KR.min.js"></script>

    <!-- Summernote 초기화 -->
    <script>
        $(document).ready(function() {
            $('#post-content').summernote({
                height: 350,
                lang: 'ko-KR',
                placeholder: '상세 내용을 입력해주세요.',
                toolbar: [
                    ['fontname', ['fontname']],
                    ['fontsize', ['fontsize']],
                    ['style', ['bold', 'italic', 'underline','strikethrough', 'clear']],
                    ['color', ['forecolor','color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['insert',['picture','link','video']],
                    ['view', ['fullscreen', 'codeview']]
                ],
                fontNames: ['맑은 고딕','궁서','굴림체','돋움체','Arial','Arial Black','Comic Sans MS','Courier New'],
                fontSizes: ['8','9','10','11','12','14','16','18','24','36'],
                callbacks: {
                    onImageUpload: function(files) {
                        uploadSummernoteImageFile(files[0], this);
                    }
                }
            });

            function uploadSummernoteImageFile(file, editor) {
                var data = new FormData();
                data.append("file", file);

                $.ajax({
                    data: data,
                    type: "POST",
                    url: "community/uploadSummernoteImage",
                    contentType: false,
                    enctype: 'multipart/form-data',
                    processData: false,
                    success: function(response) {
                        var imgUrl = JSON.parse(response).url;
                        $(editor).summernote('insertImage', imgUrl);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("파일 업로드 실패: " + textStatus + ", " + errorThrown);
                        alert("파일 업로드에 실패했습니다.");
                    }
                });
            }
        });
    </script>

</th:block>

</html>
