<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.disaster.mapper.CommunityMapper">

    <!-- 전체 게시글 수 -->
    <select id="getTotalPostCount" resultType="int">
        SELECT COUNT(*)
        FROM post
        WHERE status != 'DELETED'
    </select>

    <!-- 전체 댓글 수 -->
    <select id="getTotalCommentCount" resultType="int">
        SELECT COUNT(*)
        FROM comment
        WHERE status != 'DELETED'
    </select>

    <!-- 게시글 조회용 ResultMap (CommunityDTO 사용) -->
    <resultMap id="postDetailMap" type="com.disaster.domain.CommunityDTO">
        <id property="postId" column="post_id"/>
        <result property="memberId" column="member_id"/>
        <result property="addressId" column="address_id"/>
        <result property="muniCode" column="muni_code"/>
        <result property="disasterType" column="disaster_type"/>
        <result property="title" column="title"/>
        <result property="body" column="body"/>
        <result property="lat" column="lat"/>
        <result property="lon" column="lon"/>
        <result property="status" column="status"/>
        <result property="viewCount" column="view_count"/>
        <result property="createdAt" column="created_at" javaType="java.sql.Timestamp"/>
        <result property="updatedAt" column="updated_at" javaType="java.sql.Timestamp"/>
        <result property="nickname" column="nickname"/>
    </resultMap>

    <!-- 댓글 조회용 ResultMap (CommentDTO 사용) -->
    <resultMap id="reportedCommentMap" type="com.disaster.domain.CommentDTO">
        <id property="commentId" column="comment_id"/>
        <result property="postId" column="post_id"/>
        <result property="memberId" column="member_id"/>
        <result property="body" column="body"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at" javaType="java.sql.Timestamp"/>
        <result property="nickname" column="nickname"/>
        <result property="title" column="title"/>
    </resultMap>

    <!-- 게시글 조회 (신고된 게시글 우선) -->
    <select id="findAllPostsWithReportedFirst" resultMap="postDetailMap">
        SELECT
            p.post_id,
            p.member_id,
            p.address_id,
            p.muni_code,
            p.disaster_type,
            p.title,
            p.body,
            p.lat,
            p.lon,
            p.status,
            p.view_count,
            p.created_at,
            p.updated_at,
            m.nickname
        FROM
            post p
        JOIN
            member m ON p.member_id = m.member_id
        WHERE
            p.status != 'DELETED'
        ORDER BY
            p.status DESC, -- 'REPORTED'가 'PUBLISHED'보다 뒤에 오므로 DESC
            p.created_at DESC
    </select>

    <!-- 신고된 댓글만 조회 -->
    <select id="findReportedComments" resultMap="reportedCommentMap">
        SELECT
            c.comment_id,
            c.post_id,
            c.member_id,
            c.body,
            c.status,
            c.created_at,
            m.nickname,
            p.title
        FROM
            comment c
        JOIN
            member m ON c.member_id = m.member_id
        JOIN
            post p ON c.post_id = p.post_id
        WHERE
            c.status = 'REPORTED'
        ORDER BY
            c.created_at DESC
    </select>

    <!-- 게시글 삭제 -->
    <update id="deletePostById" parameterType="long">
        UPDATE post
        SET status = 'DELETED'
        WHERE post_id = #{postId}
    </update>

    <!-- 댓글 삭제 -->
    <update id="deleteCommentById" parameterType="long">
        UPDATE comment
        SET status = 'DELETED'
        WHERE comment_id = #{commentId}
    </update>

</mapper>