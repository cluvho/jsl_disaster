<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<div layout:fragment="content">
	<div class="container my-5">
		<div class="row justify-content-center">
			<div class="col-lg-10">
				<div class="card shadow-sm border-0">
					<div class="card-header bg-light border-0 py-4">
						<h2 class="text-center mb-0" style="font-weight: 700;">게시글 수정</h2>
					</div>
					<div class="card-body p-4 p-md-5">
						<form th:action="@{'/community/edit/' + ${writeDto.postId}}"
							th:object="${writeDto}" method="post">
							<div class="mb-4">
								<label for="disaster-type" class="form-label"><strong>재난
										유형</strong> <span style="color: red;">*</span></label> <select
									id="disaster-type" class="form-control form-control-lg"
									th:field="*{disasterType}" required>
									<option value="EARTHQUAKE">지진</option>
									<option value="TSUNAMI">쓰나미</option>
									<option value="TYPHOON">태풍</option>
									<option value="FLOOD">호우/홍수</option>
									<option value="VOLCANO">화산</option>
									<option value="FIRE">화재</option>
									<option value="LANDSLIDE">산사태</option>
									<option value="ETC">기타</option>
								</select>
							</div>

							<div class="mb-4">
								<label for="post-title" class="form-label"><strong>제목</strong>
									<span style="color: red;">*</span></label> <input type="text"
									id="post-title" class="form-control form-control-lg"
									th:field="*{title}" placeholder="제목을 입력하세요" required>
							</div>

							<div class="mb-4">
								<label for="post-content" class="form-label"><strong>내용</strong>
									<span style="color: red;">*</span></label>
								<textarea id="post-content" th:field="*{body}" required></textarea>
							</div>

							<div class="mb-4">
								<label class="form-label"><strong>위치 정보</strong> <span
									class="text-muted">(마커를 드래그하여 위치 선택)</span></label>
								<div id="map"
									style="width: 100%; height: 400px; border-radius: 8px;"></div>
							</div>

							<input type="hidden" id="lat" th:field="*{lat}" /> <input
								type="hidden" id="lon" th:field="*{lon}" />

							<p>※ 사이트 이용약관을 위반한 글을 작성할 경우 글과 계정이 삭제처리 될 수 있습니다.</p>
							<p>※ 이로 인하여 사이트 내에 문제가 발생 시 법적대응이 가능합니다.</p>

							<div class="d-grid gap-2 mt-5">
								<button type="submit" class="btn btn-primary btn-lg">수정하기</button>
								<a
									th:href="@{/community/communityDetail/{postId}(postId=${writeDto.postId})}"
									class="btn btn-secondary btn-lg">취소하기</a>
							</div>

						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<th:block layout:fragment="script">
	<style>
.form-label {
	font-size: 1.1rem;
	margin-bottom: 0.5rem;
}

.form-control-lg {
	font-size: 1rem;
	padding: 0.75rem 1rem;
}

.note-editor.note-frame {
	border: 1px solid #ced4da;
	border-radius: 0.375rem;
	box-shadow: none;
}

.note-editor.note-frame:focus-within {
	border-color: #86b7fe;
	box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.card-body .d-grid .btn {
	padding: 0.75rem;
	font-size: 1.1rem;
	font-weight: 600;
}
</style>

	<link
		href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
		rel="stylesheet">
	<link
		href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.css"
		rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/lang/summernote-ko-KR.min.js"></script>

	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdiJWNOl98gTR6XjCfDhubMwXQZVO3ejs&callback=initMap&libraries=marker&v=weekly"
		async defer>
	</script>

	<script th:inline="javascript">
        // Summernote 초기화
        $(document).ready(function() {
            $('#post-content').summernote({
                height: 350,
                lang: 'ko-KR',
                placeholder: '이곳에 내용을 입력해주세요.',
                toolbar: [
                    ['fontname', ['fontname']],
                    ['fontsize', ['fontsize']],
                    ['style', ['bold', 'italic', 'underline','strikethrough', 'clear']],
                    ['color', ['forecolor','color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['insert',['picture','link','video']],
                    ['view', ['fullscreen', 'codeview']]
                ],
                fontNames: ['맑은 고딕','궁서','굴림체','돋움체', 'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New'],
                fontSizes: ['8','9','10','11','12','14','16','18','24','36'],
                callbacks: {
                    onImageUpload: function(files) {
                        uploadSummernoteImageFile(files[0], this);
                    }
                }
            });

            function uploadSummernoteImageFile(file, editor) {
                var data = new FormData();
                data.append("file", file);
                $.ajax({
                    data: data,
                    type: "POST",
                    url: "/community/uploadSummernoteImage", // 컨트롤러의 @PostMapping 경로
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        $(editor).summernote('insertImage', response);
                    },
                    error: function() {
                        alert("이미지 파일 업로드에 실패했습니다.");
                    }
                });
            }
        });
        
        // Google Map 초기화 함수 (API 로드 후 자동 호출)
        function initMap() {
            // Thymeleaf에서 서버로부터 전달받은 사용자 주소 좌표를 가져옵니다.
            // 사용자의 주소 정보가 없으면 기본값으로 서울 시청을 사용합니다.
            const userLat = /*[[${writeDto.lat != null ? writeDto.lat : 37.5665}]]*/ 37.5665;
            const userLng = /*[[${writeDto.lon != null ? writeDto.lon : 126.9780}]]*/ 126.9780;

            const initialPosition = { lat: userLat, lng: userLng };
            
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: initialPosition,
            });

            const marker = new google.maps.Marker({
                position: initialPosition,
                map: map,
                draggable: true // 마커를 드래그할 수 있도록 설정
            });

            // 숨겨진 input 필드에 초기 좌표 설정
            document.getElementById('lat').value = initialPosition.lat;
            document.getElementById('lon').value = initialPosition.lng;

            // 마커 드래그가 끝나면 숨겨진 input 필드의 값을 업데이트
            google.maps.event.addListener(marker, 'dragend', function(event) {
                document.getElementById('lat').value = event.latLng.lat();
                document.getElementById('lon').value = event.latLng.lng();
            });
        }
    </script>
</th:block>

</html>