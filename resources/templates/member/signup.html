<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
  <div class="signuppage">
    <div class="page-wrapper">
        <div class="main-content">
            <main class="content-area">
              <h2 class="section-title">회원가입</h2>
              <div class="auth-wrap">
                <div class="form-card">
                  <form method="post" th:action="@{/member/signup}" id="signupForm" novalidate>
                  
                   <div th:if="${error}" class="alert alert-error">
                    <span th:text="${error}"></span>
                  </div>
                  
                    <div class="form-field">
                      <label for="nickname">닉네임 <span class="req">*</span></label>
                      <div class="inline-field">
                        <input id="nickname" name="nickname" type="text" required placeholder="닉네임 입력">
                        <button class="btn-outline" type="button" id="btnCheckNickname">중복확인</button>
                      </div>
                      <small id="nickMsg" class="hint"></small>
                    </div>
                    <div class="form-field">
                      <label for="email">아이디(이메일) <span class="req">*</span></label>
                      <div class="inline-field">
                        <input id="email" name="email" type="email" autocomplete="email" required
                               placeholder="you@example.com">
                        <button class="btn-outline" type="button" id="btnSendCode">인증메일 발송</button>
                      </div>
                      <small class="hint">로그인 및 알림용 이메일입니다.</small>
                    </div>
                    <div class="form-field" id="verifyField">
                      <label for="verifyCode">인증 코드 확인 <span class="req">*</span></label>
                      <div class="inline-field">
                        <input id="verifyCode" name="verifyCode" type="text" placeholder="메일로 받은 인증번호 입력">
                        <button class="btn-outline" type="button" id="btnVerifyCode">확인</button>
                      </div>
                      <small id="verifyMsg" class="hint"></small>
                    </div>
                    <div class="form-field">
                      <label for="password">비밀번호 <span class="req">*</span></label>
                      <input id="password" name="password" type="password" autocomplete="new-password" required
                             minlength="8" placeholder="영문/숫자 포함, 8자 이상">
                    </div>
                    <div class="form-field">
                      <label for="password2">비밀번호 확인 <span class="req">*</span></label>
                      <input id="password2" name="password2" type="password" autocomplete="new-password" required>
                      <small id="pwMatchMsg" class="hint"></small>
                    </div>
                    <div class="form-field">
                      <label for="realName">실명 <span class="req">*</span></label>
                      <input id="realName" name="name" type="text" required placeholder="田中太郎">
                    </div>

                    <!-- === 일본 주소 입력 부분 (수정됨) === -->
                    
                    <!-- 1단계: 우편번호 입력 -->
                    <div class="form-field">
                      <label for="postalCode">우편번호 <span class="req">*</span></label>
                      <div class="inline-field">
                        <input id="postalCode" name="postalCode" type="text" inputmode="numeric" 
                               required placeholder="1234567 (7자리 숫자)" maxlength="7" pattern="[0-9]{7}">
                        <button class="btn-outline" type="button" id="btnSearchAddress">주소 검색</button>
                      </div>
                      <small class="hint">하이픈(-) 없이 7자리 숫자로 입력하세요</small>
                    </div>

                    <!-- 2단계: 기본 주소 표시 -->
                    <div class="address-auto-fields" id="addressAutoFields" style="display:none;">
                      <div class="form-field">
                        <label for="prefecture">도도부현 <span class="req">*</span></label>
                        <input id="prefecture" name="prefecture" type="text" required readonly>
                      </div>
                      <div class="form-field">
                        <label for="city">시구정촌 <span class="req">*</span></label>
                        <input id="city" name="city" type="text" required readonly>
                      </div>
                      <div class="form-field">
                        <label for="town">정목/대자</label>
                        <input id="town" name="town" type="text" readonly>
                      </div>
                    </div>

                    <!-- 3단계: 상세 주소 입력 -->
                    <div class="form-field" id="detailAddressField" style="display:none;">
                      <label for="addrLine2">상세 주소 <span class="req">*</span></label>
                      <div class="inline-field">
                        <input id="addrLine2" name="addrLine2" type="text" 
                               placeholder="번지, 건물명 등 (예: 1-3-1 도쿄빌딩 101호)" required>
                        <button class="btn-outline" type="button" id="btnGetLocation">위치 확인</button>
                      </div>
                      <small class="hint">정확한 재난 알림을 위해 상세 주소를 입력해주세요</small>
                    </div>

                    <!-- 4단계: 지도 확인 -->
                    <div class="form-field" id="mapField" style="display:none;">
                      <label>위치 확인</label>
                      <div id="map" style="height:300px; border:1px solid #ddd; border-radius:4px; margin-bottom:10px;"></div>
                      <small class="hint">📍 위치가 정확한지 확인하고, 필요시 지도를 클릭하여 수정하세요</small>
                      <div id="coordinateInfo" style="font-size:12px; color:#666; margin-top:5px;"></div>
                    </div>

                    <!-- === 숨겨진 필드들 (서버로 전송용) === -->
                    <input type="hidden" id="prefCode" name="prefCode">
                    <input type="hidden" id="muniCode" name="muniCode">
                    <input type="hidden" id="addrLine1" name="addrLine1">
                    <input type="hidden" id="lat" name="lat">
                    <input type="hidden" id="lon" name="lon">

                    <!-- === 일본 주소 입력 끝 === -->

                    <div class="form-field">
                      <label for="phone">전화번호 (선택)</label>
                      <input id="phone" name="phone" type="tel" autocomplete="tel"
                             placeholder="090-1234-5678">
                    </div>
                    <div class="form-field">
                      <label class="checkbox">
                        <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                        <span>이용약관 동의 <span class="req">*</span></span>
                      </label>
                      <label class="checkbox">
                        <input type="checkbox" id="agreePrivacy" name="agreePrivacy" required>
                        <span>개인정보처리방침 동의 <span class="req">*</span></span>
                      </label>
                      <label class="checkbox">
                        <input type="checkbox" id="agreeMarketing" name="agreeMarketing">
                        <span>마케팅 수신 동의 (선택)</span>
                      </label>
                      <div class="tos-links">
                        <a th:href="@{/legal/terms}" target="_blank" rel="noopener">이용약관</a>
                        <span class="sep">·</span>
                        <a th:href="@{/legal/privacy}" target="_blank" rel="noopener">개인정보처리방침</a>
                      </div>
                    </div>

                    <button type="submit" class="btn-primary w-100" id="submitBtn">회원가입</button>
                  </form>
                </div>
              </div>
            </main>
        </div>
    </div>
  </div>

  <!-- Google Maps API 로드 -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdiJWNOl98gTR6XjCfDhubMwXQZVO3ejs&callback=initMap"></script>
  
  <!-- cities.js 파일 로드 -->
  <script src="/js/cities.js"></script>
  
</div>